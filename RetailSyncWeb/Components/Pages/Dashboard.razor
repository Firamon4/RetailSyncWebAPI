@page "/"
@using Microsoft.EntityFrameworkCore
@using RetailSyncWeb.Data
@using RetailSyncWeb.Entities
@using RetailSyncWeb.Services
@* ВАЖЛИВО: Інжектимо фабрику, а не сам контекст *@
@inject IDbContextFactory<AppDbContext> DbFactory
@inject SyncStatusService SyncState
@implements IDisposable
@rendermode InteractiveServer

<PageTitle>Панель керування</PageTitle>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>🚀 Real-Time Dashboard</h1>
        @if (SyncState.LastAction.Contains("Очікування"))
        {
            <span class="badge bg-secondary p-2">💤 Сон</span>
        }
        else
        {
            <span class="badge bg-success p-2">⚡ Активність</span>
        }
    </div>

    <div class="card mb-4 border-primary">
        <div class="card-header bg-primary text-white">
            📟 Live Monitor (Останнє оновлення: @SyncState.LastUpdate.ToString("HH:mm:ss"))
        </div>
        <div class="card-body bg-light">
            <h4 class="text-primary">@SyncState.LastAction</h4>
            <hr />
            <div class="row text-center">
                <div class="col-4">
                    <small class="text-muted">Тип даних</small><br />
                    <strong>@SyncState.LastPackageType</strong>
                </div>
                <div class="col-4">
                    <small class="text-muted">Оброблено сесією</small><br />
                    <strong>@SyncState.TotalProcessed</strong>
                </div>
                <div class="col-4">
                    <small class="text-muted">В черзі зараз</small><br />
                    <strong>@QueueCount</strong>
                </div>
            </div>
        </div>
    </div>

    <div class="row text-center">
        <div class="col-md-3">
            <div class="card bg-white shadow-sm mb-3">
                <div class="card-header">Товарів</div>
                <div class="card-body"><h2>@ProductsCount</h2></div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-white shadow-sm mb-3">
                <div class="card-header">Цін</div>
                <div class="card-body"><h2>@PricesCount</h2></div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-white shadow-sm mb-3">
                <div class="card-header">Замовлень</div>
                <div class="card-body"><h2>@OrdersCount</h2></div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-white shadow-sm mb-3">
                <div class="card-header">Працівників</div>
                <div class="card-body"><h2>@WorkersCount</h2></div>
            </div>
        </div>
    </div>
</div>

@code {
    private int ProductsCount = 0;
    private int PricesCount = 0;
    private int OrdersCount = 0;
    private int WorkersCount = 0;
    private int QueueCount = 0;

    protected override async Task OnInitializedAsync()
    {
        SyncState.OnChange += HandleChange;
        await LoadData();
    }

    private async void HandleChange()
    {
        // ВАЖЛИВО: Переходимо в потік UI перед роботою з даними
        await InvokeAsync(async () =>
        {
            await LoadData();
            StateHasChanged();
        });
    }

    private async Task LoadData()
    {
        // ВАЖЛИВО: Створюємо короткоживучий контекст
        using var db = DbFactory.CreateDbContext();

        QueueCount = await db.SyncPackages.CountAsync();
        ProductsCount = await db.Products.CountAsync();
        PricesCount = await db.Prices.CountAsync();
        OrdersCount = await db.InternalOrders.CountAsync();
        WorkersCount = await db.Workers.CountAsync();
    }

    public void Dispose()
    {
        SyncState.OnChange -= HandleChange;
    }
}